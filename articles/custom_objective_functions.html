<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Custom Objective Functions and Advanced Options for Optimisation in speed • speed</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="custom_objective_functions_files/libs/quarto-html/popper.min.js"></script><script src="custom_objective_functions_files/libs/quarto-html/tippy.umd.min.js"></script><link href="custom_objective_functions_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="custom_objective_functions_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom Objective Functions and Advanced Options for Optimisation in speed">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">speed</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/speed.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/complex_designs.html">Complex Agricultural Experimental Designs with speed</a></li>
    <li><a class="dropdown-item" href="../articles/custom_objective_functions.html">Custom Objective Functions and Advanced Options for Optimisation in speed</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/biometryhub/speed/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Custom Objective Functions and Advanced Options for Optimisation in speed</h1>

      <p class="author">Sam Rogers</p>
      <p class="date">2025-11-04</p>

      <small class="dont-index">Source: <a href="https://github.com/biometryhub/speed/blob/main/vignettes/custom_objective_functions.qmd" class="external-link"><code>vignettes/custom_objective_functions.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>While the <code>speed</code> package provides a range of excellent default optimisation settings for most experimental designs, researchers may need to customise the optimisation process for specific requirements. This vignette demonstrates how to:</p>
<ul>
<li>Create custom objective functions for specialised optimisation goals</li>
<li>Adjust simulated annealing parameters for better performance</li>
<li>Handle complex constraints and specialised design requirements<br>
</li>
<li>Monitor and control the optimisation process</li>
<li>Troubleshoot optimisation issues</li>
</ul>
<p>Understanding these advanced features allows researchers to fully leverage the <code>speed</code> package for complex or non-standard experimental design challenges.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://biometryhub.github.io/speed/">speed</a></span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="understanding-the-optimisation-process">Understanding the Optimisation Process<a class="anchor" aria-label="anchor" href="#understanding-the-optimisation-process"></a>
</h2>
<section class="level2"><h3 id="simulated-annealing-basics">Simulated Annealing Basics<a class="anchor" aria-label="anchor" href="#simulated-annealing-basics"></a>
</h3>
<p>The <code>speed</code> package uses simulated annealing, a probabilistic optimisation algorithm that:</p>
<ul>
<li>Starts with an initial design layout</li>
<li>Proposes modifications (treatment swaps, moves)</li>
<li>Accepts improvements and sometimes accepts worse solutions</li>
<li>Gradually reduces acceptance of worse solutions (“cooling”)</li>
<li>Converges to an optimised layout</li>
</ul></section><section class="level2"><h3 id="default-optimisation-objectives">Default Optimisation Objectives<a class="anchor" aria-label="anchor" href="#default-optimisation-objectives"></a>
</h3>
<p>The package’s default objectives typically focus on:</p>
<ul>
<li>
<strong>Minimising treatment adjacency</strong> - reducing neighbour effects</li>
<li>
<strong>Maintaining spatial balance</strong> - even treatment distribution</li>
<li>
<strong>Respecting design constraints</strong> - block structure, replication</li>
<li>
<strong>Optimising statistical efficiency</strong> - improving precision</li>
</ul></section><section class="level2"><h3 id="when-to-customise-optimisation">When to Customise Optimisation<a class="anchor" aria-label="anchor" href="#when-to-customise-optimisation"></a>
</h3>
<p>You may consider custom optimisation when:</p>
<ul>
<li>Specific neighbour relationships are more important than others</li>
<li>Non-uniform field conditions require weighted optimisation</li>
<li>Complex constraints aren’t handled by default settings</li>
<li>Multiple competing objectives need balanced consideration</li>
<li>Performance tuning is needed for large or complex designs</li>
</ul></section></section><section class="section level2"><h2 id="custom-objective-functions">Custom Objective Functions<a class="anchor" aria-label="anchor" href="#custom-objective-functions"></a>
</h2>
<section class="level2"><h3 id="understanding-objective-function-structure">Understanding Objective Function Structure<a class="anchor" aria-label="anchor" href="#understanding-objective-function-structure"></a>
</h3>
<p>Objective functions in <code>speed</code> typically follow a standard structure:</p>
<ul>
<li>
<strong>Input</strong>: Current design layout and associated data</li>
<li>
<strong>Process</strong>: Calculate penalties or scores for the input layout</li>
<li>
<strong>Output</strong>: Single numeric value (lower = better for minimisation)</li>
</ul>
<p>Custom objective functions are a powerful way to tailor the optimisation process to the unique requirements of your experiment. While the default objectives in <code>speed</code> are designed to handle a wide range of common scenarios such as minimising neighbour effects, balancing treatments spatially, and respecting block structures, real-world experiments often present additional or alternative priorities. For example, you may need to:</p>
<ul>
<li>Enforce strict replication or co-occurrence rules for treatments</li>
<li>Optimise for specific spatial or agronomic constraints</li>
<li>Balance multiple objectives simultaneously (e.g., efficiency and logistics)</li>
<li>Incorporate domain knowledge or experimental goals not captured by default settings</li>
</ul>
<p>In these cases, writing a custom objective function allows you to explicitly define what constitutes a “good” design for your context. This flexibility is especially valuable for advanced or non-standard designs, or when you want to experiment with new optimisation strategies.</p>
</section><section class="level2"><h3 id="motivating-example">Motivating Example<a class="anchor" aria-label="anchor" href="#motivating-example"></a>
</h3>
<p>A classic example of a case where the default objective function doesn’t capture all the design constraints is a <em>Balanced Incomplete Block Design</em> (BIBD), where each treatment appears in a fixed number of blocks, and every pair of treatments occurs together the same number of times. Achieving this balance is critical for valid statistical inference, but it can be challenging to obtain such a layout, especially for large or complex experiments. Due to the number of constraints involved, there are specific and limited combinations available for the layout of the design, and the default objectives may not be sufficient to guide the optimisation process towards a valid BIBD layout.</p>
<p>By writing a custom objective function, you can directly penalise deviations from the BIBD requirements such as unequal treatment replication or unequal co-occurrence of treatment pairs, thus guiding the optimisation towards a valid or near-optimal BIBD solution. The following example demonstrates how to structure such a function and integrate it into the <code>speed</code> optimisation workflow.</p>
</section><section class="level2"><h3 id="writing-a-custom-objective-function">Writing a Custom Objective Function<a class="anchor" aria-label="anchor" href="#writing-a-custom-objective-function"></a>
</h3>
<p>Let’s now walk through the process of building a custom objective function for a Balanced Incomplete Block Design (BIBD). We’ll break down the logic behind each part of the function, show how to implement it in R, and discuss how it addresses the key requirements of a BIBD. This example will illustrate how you can translate design constraints into code, and how to use your custom function within the <code>speed</code> optimisation workflow.</p>
<section class="level3"><h4 id="constraints">Constraints<a class="anchor" aria-label="anchor" href="#constraints"></a>
</h4>
<p>A BIBD has the following properties:</p>
<section class="level4"><h5 id="characteristics">Characteristics:<a class="anchor" aria-label="anchor" href="#characteristics"></a>
</h5>
<ul>
<li>Each treatment appears in exactly <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math> blocks</li>
<li>Each block contains exactly <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> treatments</li>
<li>Each pair of treatments appears together in exactly <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">λ</annotation></semantics></math> blocks</li>
<li>Perfect balance but limited parameter combinations</li>
</ul></section><section class="level4"><h5 id="parameters">Parameters:<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h5>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>v</mi><annotation encoding="application/x-tex">v</annotation></semantics></math> = number of treatments</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math> = number of blocks<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math> = number of blocks containing each treatment</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> = number of treatments per block</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">λ</annotation></semantics></math> = number of blocks containing each pair of treatments</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>k</mi><mo>=</mo><mi>v</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">bk = vr</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">λ(v-1) = r(k-1)</annotation></semantics></math>
</li>
</ul>
<p>Most of constraints can be handled by careful design of the layout and the default objectives in <code>speed</code> package, such as minimising neighbour effects and ensuring spatial balance. However, the co-occurrence of treatments is more complex and requires custom handling.</p>
</section></section><section class="level3"><h4 id="custom-objective-function-implementation">Custom Objective Function Implementation<a class="anchor" aria-label="anchor" href="#custom-objective-function-implementation"></a>
</h4>
<p>Firstly, we need to create a function that evaluates the co-occurrence of treatments in the design. The function will count the number of times each pair of treatments appears together, and simply return a list of the counts. This will also help us to check if the design meets the BIBD requirements later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_cooccurrence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design_df</span>, <span class="va">swap</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">design_df</span><span class="op">$</span><span class="va">block</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">block</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">design_df</span><span class="op">[</span><span class="va">design_df</span><span class="op">$</span><span class="va">block</span> <span class="op">==</span> <span class="va">block</span>, <span class="va">swap</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fl">2</span>,</span>
<span>      FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<p>Given an input data frame <code>design_df</code> with a column for blocks and a column for treatments, this function will return a list of treatment pairs (provided in the column given by the <code>swap</code> argument) and their counts across the blocks. Now we need to incorporate this into a custom objective function that uses this to evaluate the BIBD properties. To be able to include it within the <code>speed</code> optimisation algorithim, we need to ensure that the function returns a list with a <code>score</code> element, which is a single numeric value representing the optimality of the layout. The <code>speed</code> package is set up to minimise this score, so lower values are better, and may require taking the reciprocal of the score if higher values mean more optimal layouts in the context of a custom objective function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bibd_objective_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">layout_df</span>,</span>
<span>    <span class="va">swap</span>,</span>
<span>    <span class="va">spatial_cols</span>,</span>
<span>    <span class="va">row_column</span> <span class="op">=</span> <span class="st">"row"</span>,</span>
<span>    <span class="va">col_column</span> <span class="op">=</span> <span class="st">"col"</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">adj_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_adjacency_score.html">calculate_adjacency_score</a></span><span class="op">(</span><span class="va">layout_df</span>, <span class="va">swap</span>, <span class="va">row_column</span>, <span class="va">col_column</span><span class="op">)</span></span>
<span>  <span class="va">bal_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_balance_score.html">calculate_balance_score</a></span><span class="op">(</span><span class="va">layout_df</span>, <span class="va">swap</span>, <span class="va">spatial_cols</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pairs</span> <span class="op">&lt;-</span> <span class="fu">get_cooccurrence</span><span class="op">(</span><span class="va">layout_df</span>, <span class="va">swap</span><span class="op">)</span></span>
<span>  <span class="va">pair_bal_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">adj_score</span> <span class="op">+</span> <span class="va">bal_score</span> <span class="op">+</span> <span class="fl">10</span><span class="op">*</span><span class="va">pair_bal_score</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<p>This function follows a very similar structure to the <a href="https://biometryhub.github.io/speed/reference/objective_functions.html">default objective functions</a> in <code>speed</code>, but it adds a specific penalty for the co-occurrence of treatments. The <code>get_cooccurrence</code> function is called to calculate how many times each pair of treatments appears together, and the variance of these counts is used as a penalty term in the final score. As increasinly more treatment pairs appear the same number of times together, the variance of the pairs co-occurrence decreases, becoming more optimal. The <code>10*pair_bal_score</code> term is a weight that can be adjusted based on how important the co-occurrence balance is relative to the adjacency and balance scores. This function could be further customised to include additional penalties or adjustments based on specific design requirements, however the current implementation provides a solid foundation for optimising a BIBD layout. Also, given that custom objective functions are user-defined, they don’t require the same level of error-checking as the default functions, so we can keep the implementation relatively simple.</p>
</section></section><section class="level2"><h3 id="using-the-custom-objective-function">Using the Custom Objective Function<a class="anchor" aria-label="anchor" href="#using-the-custom-objective-function"></a>
</h3>
<p>Now that we have our custom objective function, we can use it in the <code>speed</code> optimisation process. The <code>speed</code> package allows us to specify a custom objective function using the <code>objective_function</code> argument. We also need to ensure that our layout data frame has the necessary columns for blocks, treatments, and spatial coordinates.</p>
<p>The following parameters will allow us to produce a valid BIBD layout:</p>
<ul>
<li>
<code>v</code> = 5 (number of treatments)</li>
<li>
<code>b</code> = 10 (number of blocks)</li>
<li>
<code>k</code> = 3 (number of plots per block)</li>
<li>
<code>r</code> = 6 (number of replicates of each treatment)</li>
<li>
<code>lambda</code> = 3 (number of times each treatment appears together)</li>
</ul>
<section class="level3"><h4 id="setting-up-the-design-data-frame">Setting Up the Design Data Frame<a class="anchor" aria-label="anchor" href="#setting-up-the-design-data-frame"></a>
</h4>
<p>We will create a data frame representing the BIBD layout, and then run the <code>speed</code> optimisation with our custom objective function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the data frame</span></span>
<span><span class="va">bibd_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialise_design_df.html">initialise_design_df</a></span><span class="op">(</span>items <span class="op">=</span> <span class="fl">5</span>, nrows <span class="op">=</span> <span class="fl">3</span>, ncols <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                                block_nrows <span class="op">=</span> <span class="fl">3</span>, block_ncols <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bibd_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row col treatment row_block col_block block</span></span>
<span><span class="co">#&gt; 1   1   1        T1         1         1     1</span></span>
<span><span class="co">#&gt; 2   2   1        T2         1         1     1</span></span>
<span><span class="co">#&gt; 3   3   1        T3         1         1     1</span></span>
<span><span class="co">#&gt; 4   1   2        T4         1         2     2</span></span>
<span><span class="co">#&gt; 5   2   2        T5         1         2     2</span></span>
<span><span class="co">#&gt; 6   3   2        T1         1         2     2</span></span></code></pre></div>
</div>
<p>The <code>initialise_design_df</code> function creates a data frame with 5 treatments, arranged in 10 blocks, with each block containing 3 plots. The <code>block_nrows</code> and <code>block_ncols</code> parameters define the layout of the blocks.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-bibd-layout" class="quarto-float quarto-figure quarto-figure-center" data-fig-align="center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-bibd-layout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="custom_objective_functions_files/figure-html/fig-bibd-layout-1.png" class="quarto-figure quarto-figure-center" width="1200">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bibd-layout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Initial BIBD Layout
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-bibd-layout" class="quarto-xref">Figure 1</a> shows the initial layout of the BIBD design. The treatments are systematically assigned to blocks, but we need to randomise this design, and ensure that the co-occurrence of treatments meets the BIBD requirements.</p>
</section><section class="level3"><h4 id="performing-the-optimisation">Performing the Optimisation<a class="anchor" aria-label="anchor" href="#performing-the-optimisation"></a>
</h4>
<p>Now we can run the optimisation using our custom objective function simply by passing the name to the <code>speed</code> function via the <code>obj_function</code> argument. We will also specify the <code>swap</code> argument to indicate which column contains the treatments, and the <code>spatial_factors</code> argument to include the block, row, and column information for spatial balance. This will allow the optimisation to consider both the adjacency of treatments and their spatial distribution across the blocks, while the custom objective function will ensure that the co-occurrence of treatments is balanced according to the BIBD requirements. Note also that we set <code>options(speed.random_initialisation = FALSE)</code> to ensure that the initialisation of the design is randomised.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>speed.random_initialisation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/speed.html">speed</a></span><span class="op">(</span><span class="va">bibd_df</span>, </span>
<span>                swap <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>                spatial_factors <span class="op">=</span> <span class="op">~</span> <span class="va">block</span> <span class="op">+</span> <span class="va">row</span> <span class="op">+</span> <span class="va">col</span>,</span>
<span>                obj_function <span class="op">=</span> <span class="va">bibd_objective_function</span>, </span>
<span>                seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="co">#&gt; row and col are used as row and column, respectively.</span></span>
<span><span class="co">#&gt; Optimising level: single treatment within whole design </span></span>
<span><span class="co">#&gt; Level: single treatment within whole design Iteration: 1000 Score: 6 Best: 6 Since Improvement: 360 </span></span>
<span><span class="co">#&gt; Level: single treatment within whole design Iteration: 2000 Score: 6 Best: 6 Since Improvement: 1360 </span></span>
<span><span class="co">#&gt; Early stopping at iteration 2640 for level single treatment within whole design</span></span>
<span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; Optimised Experimental Design</span></span>
<span><span class="co">#&gt; ----------------------------</span></span>
<span><span class="co">#&gt; Score: 6 </span></span>
<span><span class="co">#&gt; Iterations Run: 2641 </span></span>
<span><span class="co">#&gt; Stopped Early: TRUE </span></span>
<span><span class="co">#&gt; Treatments: T1, T2, T3, T4, T5 </span></span>
<span><span class="co">#&gt; Seed: 42</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="custom_objective_functions_files/figure-html/bibd_result-plot-1.png" width="1200"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_cooccurrence</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">design_df</span>, <span class="st">"treatment"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $`T1,T2`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T1,T3`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T1,T4`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T1,T5`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T2,T3`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T2,T4`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T2,T5`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T3,T4`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T3,T5`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`T4,T5`</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu">get_cooccurrence</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">design_df</span>, <span class="st">"treatment"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
</div>
<p>Visual inspection of the plot and the output above shows that each treatment appears exactly 3 times together as required. Hence we have successfully used our custom objective function to generate a type of design that is not possible with the default objective functions.</p>
<!---
# Adjusting Optimisation Algorithm Parameters

## Simulated Annealing Settings

### Temperature Schedule

Controlling the cooling rate and acceptance probability.


::: {.cell}

```{.r .cell-code}
# Placeholder for temperature schedule
# This will show:
# - Initial temperature selection
# - Cooling rate adjustments
# - Linear vs exponential vs adaptive schedules
# - Impact on optimisation quality
# - Convergence speed trade-offs
```
:::


### Iteration Controls

Managing the number of iterations and convergence criteria.


::: {.cell}

```{.r .cell-code}
# Placeholder for iteration controls
# This will show:
# - Maximum iteration settings
# - Convergence detection methods
# - Early stopping criteria
# - Progress monitoring
# - Computational time management
```
:::


### Move Types and Probabilities

Customising how the algorithm proposes layout changes.


::: {.cell}

```{.r .cell-code}
# Placeholder for move types
# This will show:
# - Different types of moves (swap, shift, rotate)
# - Move probability settings
# - Constraint-respecting moves
# - Large vs small perturbations
# - Adaptive move selection
```
:::


## Performance Tuning

### Large Design Optimisation

Handling computationally intensive large-scale designs.


::: {.cell}

```{.r .cell-code}
# Placeholder for large design tuning
# This will show:
# - Memory management strategies
# - Computational complexity considerations
# - Parallel processing options
# - Approximation methods for speed
# - Quality vs speed trade-offs
```
:::


### Convergence Diagnostics

Monitoring and ensuring optimisation quality.


::: {.cell}

```{.r .cell-code}
# Placeholder for convergence diagnostics
# This will show:
# - Objective function tracking
# - Convergence plots and metrics
# - Multiple run comparisons
# - Plateau detection
# - Quality assessment methods
```
:::


### Parameter Sensitivity Analysis

Understanding how parameter choices affect results.


::: {.cell}

```{.r .cell-code}
# Placeholder for parameter sensitivity
# This will show:
# - Systematic parameter testing
# - Sensitivity to initial conditions
# - Robustness across different scenarios
# - Optimal parameter identification
# - Automated parameter tuning
```
:::


# Advanced Constraint Handling

## Complex Design Constraints

### Custom Blocking Constraints

Beyond standard rectangular blocking patterns.


::: {.cell}

```{.r .cell-code}
# Placeholder for custom blocking constraints
# This will show:
# - Irregular block shapes
# - Hierarchical blocking structures
# - Overlapping constraint systems
# - Dynamic constraint adjustment
# - Constraint violation penalties
```
:::


### Treatment Assignment Rules

Specialised rules for treatment placement.


::: {.cell}

```{.r .cell-code}
# Placeholder for treatment assignment rules
# This will show:
# - Mandatory treatment positions
# - Forbidden treatment combinations
# - Sequential treatment requirements
# - Resource-based constraints
# - Logical constraint dependencies
```
:::


### Spatial Constraints

Physical or practical limitations on plot placement.


::: {.cell}

```{.r .cell-code}
# Placeholder for spatial constraints
# This will show:
# - Irregular field boundaries
# - Obstacle avoidance
# - Access path requirements
# - Equipment movement constraints
# - Safety or regulatory restrictions
```
:::


## Constraint Satisfaction Strategies

### Hard vs Soft Constraints

Managing different types of constraint requirements.


::: {.cell}

```{.r .cell-code}
# Placeholder for constraint types
# This will show:
# - Absolute requirements (hard constraints)
# - Preference-based requirements (soft constraints)
# - Penalty function design
# - Constraint priority systems
# - Feasibility checking
```
:::


### Constraint Relaxation

Strategies when exact constraint satisfaction is impossible.


::: {.cell}

```{.r .cell-code}
# Placeholder for constraint relaxation
# This will show:
# - Gradual constraint loosening
# - Minimum viable constraint satisfaction
# - Trade-off analysis
# - Alternative constraint formulations
# - User notification of violations
```
:::


# Monitoring and Control

## Quality Metrics

Assessing optimisation results.


::: {.cell}

```{.r .cell-code}
# Placeholder for quality metrics
# This will show:
# - Statistical efficiency measures
# - Design balance assessments
# - Constraint satisfaction scores
# - Comparative quality analysis
# - Recommendation systems
```
:::


## Batch and Automated Optimisation

### Multiple Design Comparison

Systematic comparison of optimisation strategies.


::: {.cell}

```{.r .cell-code}
# Placeholder for batch optimisation
# This will show:
# - Automated parameter sweeps
# - Multiple initialisation strategies
# - Comparative result analysis
# - Best design selection
# - Robustness testing
```
:::


### Workflow Integration

Incorporating optimisation into larger research workflows.


::: {.cell}

```{.r .cell-code}
# Placeholder for workflow integration
# This will show:
# - Automated design generation
# - Integration with field planning software
# - Batch processing for multiple experiments
# - Result documentation and archiving
# - Quality control pipelines
```
:::

--->
</section></section></section><section class="section level2"><h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Custom optimisation in the <code>speed</code> package provides a powerful tool for addressing complex experimental design challenges. Key benefits include:</p>
<ul>
<li>
<strong>Flexible objective functions</strong> tailored to specific research needs</li>
<li>
<strong>Fine-tuned optimisation</strong> parameters for improved performance</li>
<li>
<strong>Complex constraint handling</strong> for non-standard situations</li>
<li>
<strong>Multi-objective optimisation</strong> for balancing competing goals</li>
</ul>
<p>Successful implementation of advanced optimisation requires:</p>
<ol type="1">
<li>
<strong>Clear understanding</strong> of research objectives and constraints</li>
<li>
<strong>Systematic approach</strong> to function development and testing</li>
<li>
<strong>Careful parameter tuning</strong> with appropriate validation</li>
<li>
<strong>Thorough testing</strong> and quality assurance procedures</li>
<li>
<strong>Documentation</strong> of methods and decisions for reproducibility</li>
</ol>
<p>By leveraging these advanced features, researchers can optimise experimental designs for even the most challenging agricultural research scenarios.</p>
<section class="level2"><h3 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h3>
<section class="level3"><h4 id="optimisation-theory">Optimisation Theory<a class="anchor" aria-label="anchor" href="#optimisation-theory"></a>
</h4>
<ul>
<li>Kirkpatrick, S., Gelatt Jr, C.D., &amp; Vecchi, M.P. (1983). “Optimisation by simulated annealing”</li>
<li>Aarts, E. &amp; Korst, J. (1989). <em>Simulated Annealing and Boltzmann Machines</em>
</li>
<li>Michalewicz, Z. &amp; Fogel, D.B. (2004). <em>How to Solve It: Modern Heuristics</em>
</li>
</ul></section><section class="level3"><h4 id="experimental-design-optimisation">Experimental Design Optimisation<a class="anchor" aria-label="anchor" href="#experimental-design-optimisation"></a>
</h4>
<ul>
<li>Atkinson, A.C., Donev, A.N., &amp; Tobias, R.D. (2007). <em>Optimum Experimental Designs</em>
</li>
<li>Fedorov, V.V. &amp; Hackl, P. (1997). <em>Model-Oriented Design of Experiments</em>
</li>
<li>Bailey, R.A. (2008). <em>Design of Comparative Experiments</em>
</li>
</ul></section><section class="level3"><h4 id="computational-methods">Computational Methods<a class="anchor" aria-label="anchor" href="#computational-methods"></a>
</h4>
<ul>
<li>Press, W.H. et al. (2007). <em>Numerical Recipes: The Art of Scientific Computing</em>
</li>
<li>Nocedal, J. &amp; Wright, S.J. (2006). <em>Numerical Optimisation</em>
</li>
</ul></section></section><section class="level2"><h3 id="related-vignettes">Related Vignettes<a class="anchor" aria-label="anchor" href="#related-vignettes"></a>
</h3>
<ul>
<li>
<a href="./speed.html"><strong>Common Agricultural Experimental Designs with speed</strong></a> - Foundational design implementations</li>
<li>
<a href="./complex_designs.html"><strong>Complex Agricultural Experimental Designs with speed</strong></a> - Advanced design structures <!-- - **"Comparing Experimental Design Efficiency with speed"** - Design evaluation and selection -->
</li>
</ul>
<hr>
<p><em>This vignette demonstrates advanced customisation capabilities of the <code>speed</code> package. For standard applications, see the other package vignettes. For specific implementation questions, consult the package documentation and function help files.</em></p>
</section></section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sam Rogers, Julian Taylor, Russell Edson, Wasin Pipattungsakul, University of Adelaide, Grains Research and Development Corporation.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
